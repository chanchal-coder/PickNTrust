Mumma Deployment Guide — PickNTrust

Overview
- Goal: Safe, zero-404 deployments to EC2 with services auto-started and isolated so crashes never break the website.
- Scope: Frontend static assets, backend API, Telegram bot, and automation triggers (autosharing/Canva).

Deployment Flow (deploy-to-domain.ps1 or deploy-domain.sh)
- Build: `npm run build` produces `dist/public` (client) and `dist/server` (backend).
- Client publish: served from `dist/public` via Nginx. Artifacts are uploaded under `dist/public` alongside backend; atomic swap to `public` is deprecated.
- Nginx: config is refreshed and validated; SPA and cache headers keep assets visible after swaps.
- Backend: uploads `dist` and `ecosystem.config.cjs`, installs prod deps, ensures `.env` sets `DATABASE_URL=file:./database.sqlite`, then starts via PM2.
- Bot isolation: the Telegram bot runs as a separate PM2 app so its crash cannot affect the website.
- Health checks: verifies `/health`, bundles, and widgets; logs are tailed to confirm startup.

Quick Use
- PowerShell: `powershell -File .\deploy-to-domain.ps1 -Domain yourdomain.com -Server ec2-user@IP -KeyPath C:\path\key.pem`
- Bash: `DOMAIN=yourdomain.com SERVER=ec2-user@IP KEY=~/.ssh/key.pem APP_DIR=/home/ec2-user/pickntrust ./deploy-domain.sh`

What these scripts do
- Install Node 18, PM2, Nginx, Certbot on the server.
- Clone/update repo, install deps, and run `node build-production.js` to build client/server.
- Start backend with PM2 at `:5000` (`pickntrust-backend`).
- Configure Nginx: serve `dist/public` as SPA; proxy `/api` → backend.
- Obtain Let’s Encrypt certificates and enable HTTPS for `www` and apex.

PM2 Management
- Start/refresh: `pm2 start ecosystem.config.cjs` or `pm2 restart pickntrust-backend`.
- Bot: `pm2 restart pickntrust-bot` is included; runs independently from the website.
- Persist across reboot: `pm2 save` and `pm2 startup systemd -u ec2-user --hp /home/ec2-user` are executed.
- Log rotation: `pm2 install pm2-logrotate` with sane defaults to keep logs tidy.

Services and Isolation
- Website (Nginx + static assets): serves `/home/ec2-user/pickntrust/dist/public`. Cache headers on index prevent stale loads post-deploy.
- Backend API (`pickntrust-backend`): listens on port `5000`, uses SQLite at `./database.sqlite`.
- Telegram bot (`pickntrust-bot`): independent PM2 process; crashes do not affect the website.
- Autosharing/Canva: implemented in backend services; they ride with the backend. Backend crashes are auto-restarted by PM2; failures won’t break static site.

PrimePicks Fallback Widget
- Purpose: Always show at least one widget in PrimePicks header.
- Script: `scripts/fix-fallback-widget.cjs` inserts/ensures an active header widget for `prime-picks` and enables mobile/desktop flags.
- Integration: The deploy script uploads then runs this script; an API check confirms header widgets are available.

Credential Persistence
- Priority: backend reads credentials from Admin panel (database). Falls back to environment variables if database is empty.
- PM2 restarts preserve environment unless updated; after deployment, credentials remain until changed via Admin.

Canva Automation
- Controls: backend Admin Settings API (`PUT /api/admin/canva/settings`) must be fixed to enable automation.
- Current: automation can be disabled at the database level; manual social posting still works.
- Impact: Even if automation fails, website remains functional; PM2 isolates and restarts backend on crash.

Health Checks
- Website: `https://pickntrust.com/` returns 200 and contains `assets/index-*.js`.
- API: `https://www.pickntrust.com/health` and `https://www.pickntrust.com/api/status` return 200.
- Assets: `https://pickntrust.com/assets/index-*.js` returns 200.
- Widgets: `https://pickntrust.com/api/widgets/prime-picks/header` returns non-empty JSON.

Troubleshooting
- 404 assets during deploy: With `dist/public` as root, cache headers on `index.html` prevent stale loads; if assets mismatch, re-run deploy to rebuild `dist/public`.
- Backend not starting: Use `pm2 status` then `pm2 logs pickntrust-backend --lines 100`; confirm Node 18 and correct working directory.
- Database path mismatch: Ensure `.env` sets `DATABASE_URL=file:./database.sqlite`. Without it, server may resolve `dist/server/database.sqlite`; fix env or update server DB path resolution.
- Categories missing: Run `seed-form-flags.sql` and verify `/api/categories/*` endpoints show expected flags and counts. If PM2 uses the wrong DB, correct path then rerun seeding.
- Widgets missing: Run `node scripts/fix-fallback-widget.cjs` in `/home/ec2-user/pickntrust`.
- Nginx errors: Validate with `sudo nginx -t` and reload with `sudo systemctl reload nginx`.

EC2 Runtime Notes
- Node.js 18 is installed system-wide (dnf/yum/apt) to avoid NVM surprises.
- A 2GB swapfile is created if none exists to reduce OOM on small instances.
- Ownership enforced on `/home/ec2-user/pickntrust` to keep deployments smooth.

Redeploy Checklist
- `npm run build` succeeds locally.
- Run `deploy-to-domain.ps1`.
- Verify site root and `/prime-picks` load; check `/health`, asset bundles, and header widgets.
- Confirm `pm2 status` shows both apps online; logs show no immediate errors.

That’s all — this covers the exact deployment process, auto-start behavior, isolation guarantees, and fallback measures.
Domain Deployment (pickntrust.com)
---------------------------------
Goal
- Make pickntrust.com the canonical domain.
- Redirect www.pickntrust.com to pickntrust.com with 301 (both HTTP and HTTPS).

Prerequisites
- DNS A/AAAA for pickntrust.com and www.pickntrust.com points to EC2 IP.
- SSH key present at C:\Users\sharm\.ssh\pnt08.pem.

Steps (from Windows PowerShell)
1) Set variables:
   $env:DOMAIN = "pickntrust.com"
   $env:SERVER = "ec2-user@51.20.55.153"
   $env:KEY = "C:\Users\sharm\.ssh\pnt08.pem"

2) Run deploy script:
   bash ./deploy-domain.sh
   (Script installs Nginx, builds app, starts PM2, provisions certs, deploys configs.)

3) Enforce 301 redirect (www → apex) and force HTTPS:
   On server, add Nginx config:
   /etc/nginx/conf.d/www-pickntrust-redirect.conf
   server {
     listen 80;
     server_name www.pickntrust.com;
     location ^~ /.well-known/acme-challenge/ { root /var/lib/letsencrypt; default_type text/plain; try_files $uri =404; }
     return 301 https://pickntrust.com$request_uri;
   }
   server {
     listen 80;
     server_name pickntrust.com;
     location ^~ /.well-known/acme-challenge/ { root /var/lib/letsencrypt; default_type text/plain; try_files $uri =404; }
     return 301 https://pickntrust.com$request_uri;
   }
   server {
     listen 443 ssl;
     server_name www.pickntrust.com;
     ssl_certificate /etc/letsencrypt/live/pickntrust.com/fullchain.pem;
     ssl_certificate_key /etc/letsencrypt/live/pickntrust.com/privkey.pem;
     return 301 https://pickntrust.com$request_uri;
   }

   Reload Nginx:
   sudo nginx -t && sudo nginx -s reload

4) Verify
   curl -I https://www.pickntrust.com   # Expect 301 → https://pickntrust.com
   curl -I http://www.pickntrust.com    # Expect 301 → https://pickntrust.com
   curl -fsS https://pickntrust.com/api/status

Notes
- No data loss: only Nginx config and PM2 app process.
- Certbot uses webroot at /var/lib/letsencrypt (ACME challenge kept via HTTP).

Top Picks Trigger — Reference
---------------------------------
- Purpose: automatically add `top-picks` to `display_pages` whenever a product in `unified_content` is marked featured (`is_featured` set true). Also ensures `status` defaults to `active` and `visibility` to `public` for featured items.
- Install (one-time): `node scripts/run-add-top-picks-triggers.cjs` — installs triggers from `scripts/add-top-picks-triggers.sql` into the current `database.sqlite`.
- Backfill existing featured rows: run `scripts/tag-top-picks.sql` against the DB to add missing `top-picks` for already-featured products.
- Verify: `node check-display-pages.cjs` or run `server/check-pages.sql` in SQLite to confirm `TOP_PICKS` counts and recent items include `top-picks` in `display_pages`.
- Persistence: this is a one-time setup; triggers persist across deployments. Only re-run after a database reset or if you switch to a new DB file.

Static Banners — Config & Import
---------------------------------
- Source file (before build): `client/src/config/banners.json`
- Build output (served by Nginx): `dist/public/config/banners.json`
- Resolver/env (PM2 ecosystem):
  - `FRONTEND_STATIC_DIR=/home/ec2-user/pickntrust/dist/public`
  - `STATIC_BANNERS_PATH=/home/ec2-user/pickntrust/dist/public/config/banners.json`
  - Optional: `DEBUG_BANNERS=1` (server logs the resolved path and fallbacks)

Endpoints
- Inspect resolved static config: `GET /api/admin/banners/static-config`
- Write static config file: `POST /api/admin/banners/static-config` with body `{ config: { ... } }`
- Import static into DB: `POST /api/admin/banners/import-static` with body `{ replaceExisting: boolean, allowDuplicates: boolean }`

Behavior
- Import applies to any page keys present in `banners.json` (e.g., `home`, `services`, `products`).
- Pages missing from `banners.json` won’t receive static banners; they will show none or fallback.
- If env vars aren’t applied, the server uses fallback static file (e.g., “Welcome / Top Deals / Premium Services”).

Post-Deploy Alignment (recommended)
1) Ensure PM2 starts via `ecosystem.config.cjs` so envs apply:
   - Run: `powershell -File .\scripts\pm2-refresh-ecosystem.ps1` (remotely runs `pm2 delete pickntrust-backend && pm2 start ecosystem.config.cjs --update-env`)
2) Verify static resolver:
   - Run: `powershell -File .\scripts\get-static-config.ps1` and check it shows smartphone/kitchen/fashion banners from `dist/public/config/banners.json`.
3) Import static to DB without duplicates:
   - Run: `powershell -File .\scripts\trigger-import-static.ps1` (uses `replaceExisting=true`, `allowDuplicates=false`).
4) Confirm dynamic banners:
   - Check: `GET /api/banners/home` returns smartphone/kitchen/fashion entries.

Troubleshooting
- Seeing “Welcome / Deals / Services” after deploy:
  - Restart backend with ecosystem envs: `pm2 delete pickntrust-backend && pm2 start ecosystem.config.cjs --update-env && pm2 save`.
  - Verify static path with `/api/admin/banners/static-config`.
  - Ensure `/home/ec2-user/pickntrust/dist/public/config/banners.json` exists and is from the latest build.
  - Re-run import with `replaceExisting=true`, `allowDuplicates=false`.
- Duplicate rows after import:
  - Use `allowDuplicates=false` to avoid new inserts; use `replaceExisting=true` to overwrite existing rows.
- Add banners for more pages:
  - Add arrays for those pages in `client/src/config/banners.json`, rebuild/deploy, then import.

Admin Alternative
- You can manage page-specific banners in the Admin Banner Management UI (writes directly to DB; no deploy required). Use the static import only to seed/realign from `banners.json`.
Admin Checks — Browse Categories
- Verify forms endpoints: `https://www.pickntrust.com/api/categories/forms/products`, `https://www.pickntrust.com/api/categories/forms/services`, `https://www.pickntrust.com/api/categories/forms/aiapps`.
- Expected counts: Products = 13, Services = 19, Apps & AI = 16.
- If mismatched, reseed and promote parents:
  `powershell -ExecutionPolicy Bypass -File scripts\deploy-seed-form-flags.ps1 -Server ec2-user@<EC2-IP> -KeyPath C:\Users\sharm\.ssh\pnt08.pem -DbPath /home/ec2-user/pickntrust/database.sqlite -ApiBase https://www.pickntrust.com`.
- Re-verify counts and keep logs for audit.